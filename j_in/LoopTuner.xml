<?xml version="1.0" encoding="UTF-8" ?>
<doc>
<title>Loop Tuner</title>

<para>
<ptitle>About Loop Tuner</ptitle>
 Loop Tuner is a tool for PCM format files (.WAV, Ogg Vorbis, etc.) to:<r/>
<ul>
<li>Set up seamless loops or " <kw>Links</kw> " that perform jumps (change playback position) based on conditions.</li>
<li>Set up " <kw>Labels</kw> " that trigger events in Kirikiri when playback reaches a specific position.</li>
</ul>
 This information is saved as a file with .sli appended to the PCM filename (for example, se001.wav becomes se001.wav.sli). These files are automatically loaded when opening PCM files with the <at href="f_WaveSoundBuffer.html">WaveSoundBuffer class</at>.<r/>
</para>


<para>
<ptitle>What is a Seamless Loop?</ptitle>
 Even without Loop Tuner, you can perform loop playback using the <at href="f_WaveSoundBuffer_looping.html">WaveSoundBuffer.looping</at> property. However, this only allows simple loops that play from the beginning of the sound and return to the beginning once the end is reached.<r/>
 With Loop Tuner, as shown in the diagram below, you can set a loop that plays to an arbitrary point and then returns to another arbitrary point. This can be used for looping songs with an anacrusis (pickup notes), or for sounds that cannot be repeated from the very beginning, such as an engine starting followed by a continuous engine loop.<r/>
<r/>
<img src="lt_seamless_loop.png"/><r/>
<r/>
 In these cases, if the timing of the repetition is not strictly adjusted, crackling noises like "clicks" or "pops" will occur at the loop point. Loop Tuner provides features to assist in fine-tuning this timing, making it easy to achieve seamless loops.<r/>
 Additionally, in rare cases where noise cannot be removed no matter how much you adjust, Loop Tuner also has a function to reduce this noise by performing a very short (approx. 50ms) crossfade near the link.<r/>
</para>

<para>
<ptitle>Conditional Links</ptitle>
 Conditional links can be used for situations like "I want to loop a song, but when a certain condition is met, I want to exit the loop and proceed to the next melody."<r/>
 In Loop Tuner, information for changing the playback position is called a "Link," and conditions can be attached to these links.<r/>
 Loop Tuner can manage 16 "Flags," which hold values from 0 to 9999. You can set conditions for any link, such as "Flag #X is equal to Y," "Flag #X is not Y," or "Flag #X is less than or equal to Y." The link will only be followed if the condition is met.<r/>
 Flags can be tested by changing their values within Loop Tuner, and they can also be manipulated via script using the <at href="f_WaveSoundBuffer_flags.html">WaveSoundBuffer.flags property</at>.<r/>
</para>


<para>
<ptitle>Labels</ptitle>
 "Labels" can be set for purposes such as "I want to trigger an event when the playback position reaches a specific spot."<r/>
 When a label is passed, a <at href="f_WaveSoundBuffer_onLabel.html">WaveSoundBuffer.onLabel</at> event occurs. Since the label name is passed as a parameter to the event, you can identify which label was passed.<r/>
<r/>
 Furthermore, by setting a special " <kw>Expression</kw> " on a label, you can increase, decrease, or set flag values when the label is passed.<r/>
 Combined with the "Conditional Links" mentioned above, you can achieve things like playing a specific section exactly four times.<r/>
</para>

<para>
<ptitle>Links, Labels, and Buffering</ptitle>
 Kirikiri's WaveSoundBuffer always buffers sound. After decoding (reading from a file or expanding compressed audio), it does not play it immediately; instead, it stores it in memory called a buffer before playback.<r/>
 This means decoding is always happening ahead of the actual playback position, with a maximum lead of 2 seconds by default.<r/>
 Since link conditions are tested at the time of decoding, even if you manipulate a flag, the effect may not be seen for up to 2 seconds. Therefore, caution is needed as changing a condition right before a link during playback might not affect that link in time.<r/>
 "Up to 2 seconds" means it may be shorter depending on the situation. If the CPU has spare capacity and decoding is sufficient, it generally maintains 2 seconds, but if the CPU is busy with other tasks and decoding is delayed, it may drop below 2 seconds.<r/>
<r/>
 Regarding labels, please note that while the label event occurs when the actual "playback position" reaches that spot, the label "expression" is executed when the "decoding position" reaches that spot.<r/>
</para>

<para>
<ptitle>Supported Formats</ptitle>
 Loop Tuner currently supports the following PCM formats:<r/>
<ul>
<li>Uncompressed Wave (extension .wav)</li>
<li>MS-ADPCM (extension .wav)</li>
<!-- <li>TCWF (extension .tcw)</li> -->
<li>Ogg Vorbis (extension .ogg)</li>
</ul>
<r/>
Loop Tuner uses the same plugins as the Kirikiri main engine. In the standard distribution, each plugin is detected automatically, so no special configuration is required.<r/>
</para>


<para>
<ptitle>Main Screen</ptitle>
 When you start Loop Tuner (krkrlt.exe), the following screen appears (the screen below shows a file actually loaded):<r/>
<img src="lt_main_window.png" /><r/>
<r/>

<dl>

<dt>Reduced Waveform Display Area</dt>
<dd>
 This area displays a reduced waveform of the entire sound. Red horizontal lines represent links, and green vertical lines represent labels.<r/>
 Clicking here allows you to display that vicinity in the main waveform display area. Double-clicking starts playback from that position.<r/>
 Since creating the reduced waveform takes time, it may not be fully displayed immediately after loading a sound or changing the window width (it is created in the background, so it will appear over time).<r/>
</dd>



<dt>Timeline / Label Display Area</dt>
<dd>
 The timeline is displayed here, allowing you to see how much time has elapsed from the start of the sound at any position.<r/>
 Label information is also displayed here. Inverted triangle marks represent labels.<r/>
 Clicking a label selects it.<r/>
 Double-clicking a label allows you to edit the label name.<r/>
</dd>


<dt>Waveform Display Area</dt>
<dd>
 The sound waveform is displayed here.<r/>
 You can zoom in or out on the waveform using [View|Zoom In] or [View|Zoom Out].<r/>
 Clicking the waveform displays a blinking vertical bar (called the caret). [Play|Play from Current Position] starts playback from this location. Also, [View|Zoom In] and [View|Zoom Out] center the zoom on this position.<r/>
 Double-clicking the waveform starts playback from that position.<r/>
 If the waveform does not fit on the screen, a scrollbar appears at the bottom.<r/>
 Vertical dotted lines in the waveform display represent label or link positions. These dotted lines can be dragged with the mouse to adjust their positions.
</dd>

<dt>Link Display Area</dt>
<dd>
 Link information is displayed here.<r/>
 Links are shown as arrows; when the playback position reaches the base of the arrow, it moves to the tip of the arrow.<r/>
 Dotted links represent conditional links.<r/>
 Clicking a link selects it.<r/>
 Double-clicking a link opens the link editing screen.<r/>
</dd>




<dt>[File(F)|Open(O) ...](<img src="lt_open.png" />) Shortcut: Ctrl+O</dt>
<dd>
 Opens a sound file to operate on. If the currently open file has been modified, a dialog box will ask if you want to save the changes.
</dd>

<dt>[File(F)|Save(S)](<img src="lt_save.png" />) Shortcut: Ctrl+S</dt>
<dd>
 Saves the current content to a file. The filename will be the PCM filename with .sli appended (e.g., se001.wav becomes se001.wav.sli).
</dd>

<dt>[File(F)|Exit(X)]</dt>
<dd>
 Exits Loop Tuner. If the currently open file has been modified, a dialog box will ask if you want to save the changes.
</dd>

<dt>[Edit(V)|Undo(U)](<img src="lt_undo.png" />) Shortcut: Ctrl+Z</dt>
<dd>
 Cancels the last edit and returns to the previous state.
</dd>

<dt>[Edit(V)|Redo(R)](<img src="lt_redo.png" />)</dt>
<dd>
 Re-applies a change that was undone with "Undo."
</dd>

<dt>[Edit(V)|Delete(D)](<img src="lt_delete.png" />) Shortcut: Del</dt>
<dd>
 Deletes the currently selected item.
</dd>

<dt>[Edit(V)|Create New Link(J)](<img src="lt_new_link.png" />)</dt>
<dd>
 Creates a new link. The link is created with the last clicked position as the destination and the second-to-last clicked position as the source. Therefore, to create a link, first click the source position, then click the destination position, and finally select this menu item.<r/>
</dd>

<dt>[Edit(V)|Create New Label(J)](<img src="lt_new_label.png" />)</dt>
<dd>
 Creates a new label.
</dd>

<dt>[Edit(V)|Edit Link(T) ...](<img src="lt_edit_link.png" />)</dt>
<dd>
 Opens a screen to adjust the currently selected link.
</dd>

<dt>[Edit(V)|Create Label at Playback Position(A)](<img src="lt_new_label_on_play.png" />) Shortcut: A or S</dt>
<dd>
 Creates a label at the current playback position. This allows you to create labels via keypress. If it is difficult to press the A key repeatedly, you can also use the S key; alternating between A and S is easier.
</dd>

<dt>[Edit(V)|Delete All Labels(Q)](<img src="lt_clear_all_labels.png" />) Shortcut: Ctrl + Q</dt>
<dd>
 Deletes all labels.
</dd>

<dt>[View(V)|Zoom In(I)](<img src="lt_zoom_in.png" />) Shortcut: I</dt>
<dd>
 Enlarges the waveform.
</dd>

<dt>[View(V)|Zoom Out(O)](<img src="lt_zoom_out.png" />) Shortcut: O</dt>
<dd>
 Shrinks the waveform.
</dd>

<dt>[View(V)|Follow Playback Position(F)](<img src="lt_follow.png" />) Shortcut: F</dt>
<dd>
 Makes the screen follow the playback position.
</dd>

<dt>[View(V)|Show Toolbar(T)]</dt>
<dd>
 Toggles the toolbar display.<r/>
</dd>



<dt>[View(V)|Show Flags(G)](<img src="lt_edit_flags.png" />)</dt>
<dd>
 Displays the flag editing bar.<r/>
 The flag editing bar has 16 fields, each representing a flag. You can change their values. Double-clicking a field toggles the value between 0 and 1.<r/>
 Clicking the [C] button on the far left resets all flags to 0.<r/>
</dd>

<dt>[View(V)|Show Reduced Waveform(E)]</dt>
<dd>
 Toggles the reduced waveform display.<r/>
</dd>

<dt>[View(V)|Show Status Bar(S)]</dt>
<dd>
 Toggles the status bar display.<r/>
</dd>



<dt>[Play(P)|Stop(Q)](<img src="lt_stop.png" />) Shortcut: Q</dt>
<dd>
 Stops playback.
</dd>

<dt>[Play(P)|Play from Beginning(P)](<img src="lt_play_from_first.png" />) Shortcut: P</dt>
<dd>
 Starts playback from the beginning of the sound.
</dd>

<dt>[Play(P)|Play from Current Position(C)](<img src="lt_play_from_current.png" />) Shortcut: Space</dt>
<dd>
 Starts playback from the caret position.
</dd>

<dt>[Play(P)|Ignore Links and Play(G)](<img src="lt_ignore_links.png" />) Shortcut: G</dt>
<dd>
 When this item is checked (button appears pressed), all links are ignored during playback. Even if the playback position reaches a link source, the link will not be followed.
</dd>

<dt>[Help(H)|Help(H)]</dt>
<dd>
 Displays the help.
</dd>


<dt>[Help(H)|About Loop Tuner(A)]</dt>
<dd>
 Displays copyright and version information for Loop Tuner.
</dd>

</dl>

</para>


<para>
<ptitle>Link Tuning Screen</ptitle>
 You can display this screen by selecting [Edit|Edit Link] or by double-clicking a link.<r/>
 For shortcut keys available on this screen, please refer to the menu that appears when right-clicking the waveform.<r/>
<r/>
<img src="lt_link_tuner.png" />
<r/>
<r/>
<dl>

<dt>Link Condition</dt>
<dd>
 The top section is for editing link conditions.<r/>
 By checking the [Conditional] checkbox, you can make this link a conditional link. Specify the condition in the right-hand section.<r/>
 Conditions can be specified in the following format:<r/>
<r/>
 <tt>Flag #[A] is [Condition] [B]</tt><r/>
<r/>
 [A] specifies the flag number (0-15) to compare.<r/>
 [B] specifies the numerical value (0-9999) to compare against.<r/>
 [Condition] specifies the comparison. There are six options: "Equal to," "Not equal to," "Greater than," "Greater than or equal to," "Less than," and "Less than or equal to."<r/>
<r/>
 While values from 0 to 9999 can be used, it is generally better to use 0 or 1 unless you have a special purpose (0 and 1 can be easily toggled by double-clicking in the flag editing bar on the main screen).<r/>
</dd>

<dt>Waveform Display Area</dt>
<dd>
 In the waveform display area, you can check the waveform immediately before the link and immediately after the link. The blue waveform on the left is before the link, and the red waveform on the right is after the link. The faint waveforms shown are the "after" waveform overlaid on the "before" side, and vice versa.<r/>
 The waveforms can be adjusted by dragging with the mouse. They can also be adjusted using the link adjustment buttons located below the waveform display.<r/>
</dd>

<dt>Link Adjustment Buttons</dt>
<dd>
 There are 12 link adjustment buttons; the 6 on the left adjust the position before the link, and the 6 on the right adjust the position after the link.<r/>

<dl>
    <dt>To Previous Crossing Point(<img src="lt_left_cross_point.png" />)</dt>
    <dd>Finds the previous crossing point (where the waveform crosses the -Inf line) and moves there.</dd>

    <dt>Back 20 Steps(<img src="lt_20_step_left.png" />)</dt>
    <dd>Moves back 20 steps. One step depends on the waveform zoom; if the zoom is 1/16, it is 16 samples; if 1/1, it is 1 sample.</dd>

    <dt>Back 1 Step(<img src="lt_1_step_left.png" />)</dt>
    <dd>Moves back 1 step.</dd>

    <dt>Forward 1 Step(<img src="lt_1_step_right.png" />)</dt>
    <dd>Moves forward 1 step.</dd>

    <dt>Forward 20 Steps(<img src="lt_20_step_right.png" />)</dt>
    <dd>Moves forward 20 steps.</dd>

    <dt>To Next Crossing Point(<img src="lt_right_cross_point.png" />)</dt>
    <dd>Finds the next crossing point (where the waveform crosses the -Inf line) and moves there.</dd>
</dl>

</dd>


<dt>Zoom Buttons(<img src="lt_zoom_in.png" /><img src="lt_zoom_out.png" />)</dt>
<dd>
 Changes the zoom level. The zoom is displayed next to these buttons as /1, etc. /1 represents 1/1 (1 pixel per sample). /16 represents 1/16 (1 pixel per 16 samples).<r/>
</dd>

<dt>Smooth Link(<img src="lt_smooth.png" />)</dt>
<dd>
 Makes the link smooth. When this button is checked (pressed), Loop Tuner and Kirikiri will play the waveforms before and after the link mixed with a short crossfade (50ms). This can reduce "clicks" and "pops" caused by waveforms not matching perfectly at the link point.<r/>
</dd>

<dt>Stop Playback(<img src="lt_stop.png" />)</dt>
<dd>
 Stops playback.<r/>
</dd>

<dt>Play(<img src="lt_play_before.png" />)</dt>
<dd>
 Plays the vicinity of the link. You can play from 0.5s, 1s, 2s, 3s, or 5s before the link.<r/>
 When a play button is clicked, it becomes marked (changes color). Subsequently, pressing the Space key will perform the same action as clicking that button (playing from the same duration before the link as the last clicked button).<r/>
</dd>

<dt>[OK] Button</dt>
<dd>
 Confirms changes and closes the window.
</dd>

<dt>[Cancel] Button</dt>
<dd>
 Discards changes and closes the window.
</dd>

</dl>


<note>
 If an unconditional link and one or more conditional links have the same source position, the conditional link tests take priority. If none of the conditions are met, the unconditional link is followed.<r/>
 If there are multiple unconditional links, which one is used is undefined.<r/>
 If there are multiple conditional links, the order of testing is undefined.<r/>
 In this context, "same position" means strictly the exact same position. If the positions differ by even one sample, they are not considered the same.
</note>


</para>


<para>
<ptitle>Label Expressions</ptitle>
 Labels can perform special processing on flags when passed by setting an "Expression" with a special format.<r/>
 To write an "Expression" in a label, the label name must start with a ':' (colon).<r/>
 An expression consists of the target flag, an " <kw>Operator</kw> " representing the process, and an " <kw>Operand</kw> " serving as a parameter for the operator (some operators do not have operands).<r/>
 The target flag is specified by enclosing the flag number (0-15) in '[' ']' (brackets). For operands, write the numerical value directly, or if you want to specify another flag, enclose its number (0-15) in '[' ']' (brackets).<r/>
 The following operators are available:<r/>
<dl>
<dt>=</dt>
<dd>Assigns the operand value to the flag.</dd>
<dt>+=</dt>
<dd>Adds the operand value to the flag.</dd>
<dt>-=</dt>
<dd>Subtracts the operand value from the flag.</dd>
<dt>++</dt>
<dd>Increments the flag value by 1.</dd>
<dt>--</dt>
<dd>Decrements the flag value by 1.</dd>
</dl>
 In all cases, the flag value range is strictly 0 to 9999. Values below 0 are corrected to 0, and values above 9999 are corrected to 9999.<r/>
<r/>
Examples:<r/>
<tt>:[0]=1    </tt>Assign 1 to flag #0.<r/>
<tt>:[1]=[0]  </tt>Assign the value of flag #0 to flag #1.<r/>
<tt>:[1]+=3   </tt>Add 3 to flag #1.<r/>
<tt>:[0]++    </tt>Increment flag #0 by 1.<r/>
<note>
 If multiple labels are at the same position, the order of execution is undefined.
</note>
</para>



<para>
<ptitle>Hints and Tips</ptitle>
<dl>
<dt>Adjusting Links</dt>
<dd>
 At PCM link points, crackling noise will occur if the adjustment is poor. While the "Smooth Link" feature can reduce this noise, it is recommended to try adjusting without Smooth Link first.<r/>
<r/>
 For music generated in electronic environments like sound modules and sequencers, you can often find points where the waveforms before and after the link match almost perfectly, as shown below.<r/>
<img src="lt_link_tuner_wave_match.png" /><r/>
<r/>
 Even if some noise is inevitable, the following points can help make it less noticeable:<r/>
<ul>
<li>Noise is less noticeable if the link point is placed immediately before a snare or cymbal drum hit. Points immediately before high-pitched sounds or percussive sounds are also advantageous.</li>
<li>Noise is less noticeable if the link point is placed at a crossing point.</li>
</ul>
</dd>


<dt>Controlling Song Progression with Conditional Links</dt>
<dd>
 You can control song progression to reflect game progress or scenes—such as starting with an intro, looping, and then exiting the loop to enter another section based on certain conditions—using conditional links and flag manipulation.<r/>
 However, links only operate at the positions pre-specified in Loop Tuner. Even if you change a link condition, the playback position will not change until that link position is reached.<r/>
 If a loop is long and waiting to reach the end to exit is a problem, you must design the song structure so that it can exit mid-loop.<r/>
 For example, as shown below:<r/>
<r/>
<img src="lt_complex_loop.png" />
<r/>
 At the start of playback, Flag 0 is 0. The "Intro" plays, and the "Loop" section repeats.<r/>
 If the game progresses and Flag 0 becomes 1, the "Loop" will be exited at either point (1) or (2).<r/>
 If it exits at (1), it plays through the "(1)->(3) Transition" to (3), and then the "Remaining Part" plays.<r/>
 If it exits at (2), after playing the "(2)->(3) Transition," it jumps to (3) via a link, and the "Remaining Part" plays.<r/>
<r/>
 Many different applications are possible.
</dd>


</dl>


</para>



</doc>